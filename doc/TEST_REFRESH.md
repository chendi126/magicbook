# 🧪 配色库刷新功能测试指南

## 测试目的
验证每次保存配色方案后，配色库列表能够**立即自动刷新**并显示新保存的方案。

---

## 测试前准备

### 1. 清空现有数据（可选）
如果想从零开始测试，可以：
- 删除应用数据
- 或者在配色库中删除所有现有方案

### 2. 打开日志窗口
在 DevEco Studio 中：
1. 点击底部的 **Log** 标签
2. 选择你的设备
3. 筛选器输入：`LibraryPage` 或 `保存`

---

## 测试步骤

### 测试 1: 首次保存
1. 打开应用，在"提取"页面
2. 点击"选择图片"，选择一张色彩丰富的图片
3. 等待颜色提取完成
4. 点击"保存配色方案"按钮
5. 输入方案名称：`测试方案1`
6. 点击"保存"

**预期结果**:
- ✅ 提示"保存成功"
- ✅ 自动跳转到"配色库"页面
- ✅ **立即**看到"测试方案1"显示在列表中
- ✅ 显示正确的颜色条

**日志检查**:
```
开始保存配色方案: 测试方案1
配色方案数据: {...}
保存结果 rowId: 1
触发刷新信号: 1731234567890
refreshLibrary 已更新为: 1731234567890
已切换到配色库页面
onRefreshLibrary 被触发，refreshLibrary = 1731234567890
开始加载配色方案...
从数据库获取到 1 个配色方案
配色方案列表已更新，当前显示 1 个方案
加载配色方案完成
```

---

### 测试 2: 连续保存多个方案
1. 切换回"提取"页面
2. 点击"重新选择"，选择另一张图片
3. 等待颜色提取完成
4. 点击"保存配色方案"
5. 输入方案名称：`测试方案2`
6. 点击"保存"

**预期结果**:
- ✅ 提示"保存成功"
- ✅ 自动跳转到"配色库"页面
- ✅ **立即**看到"测试方案2"显示在列表顶部（最新的在上面）
- ✅ "测试方案1"仍然在列表中
- ✅ 总共显示 2 个方案

**日志检查**:
```
保存结果 rowId: 2
触发刷新信号: 1731234567891
onRefreshLibrary 被触发，refreshLibrary = 1731234567891
从数据库获取到 2 个配色方案
配色方案列表已更新，当前显示 2 个方案
```

---

### 测试 3: 快速连续保存
1. 切换回"提取"页面
2. 选择图片，保存为"测试方案3"
3. **立即**再次选择图片，保存为"测试方案4"
4. **立即**再次选择图片，保存为"测试方案5"

**预期结果**:
- ✅ 每次保存后都能立即在配色库中看到新方案
- ✅ 配色库显示 5 个方案
- ✅ 顺序正确（最新的在最上面）

---

### 测试 4: 删除后刷新
1. 在配色库中，点击"测试方案3"的"删除"按钮
2. 在原生对话框中点击"删除"

**预期结果**:
- ✅ 提示"删除成功"
- ✅ "测试方案3"立即从列表中消失
- ✅ 剩余 4 个方案

**日志检查**:
```
开始加载配色方案...
从数据库获取到 4 个配色方案
配色方案列表已更新，当前显示 4 个方案
```

---

## 常见问题排查

### 问题 1: 保存后配色库是空的
**可能原因**:
- 数据库未初始化
- 保存失败（rowId = -1）

**检查方法**:
1. 查看日志中的 `保存结果 rowId`
2. 如果是 -1，说明数据库有问题
3. 查找日志中的"数据库初始化成功"

**解决方法**:
- 重启应用
- 检查 `EntryAbility.ets` 中的数据库初始化代码

---

### 问题 2: 保存后需要手动切换 Tab 才能看到
**可能原因**:
- `@Watch` 没有触发
- `refreshLibrary` 没有更新

**检查方法**:
1. 查看日志中是否有"触发刷新信号"
2. 查看日志中是否有"onRefreshLibrary 被触发"

**解决方法**:
- 确保 `@Provide` 和 `@Consume` 正确配置
- 确保 `@Watch('onRefreshLibrary')` 拼写正确

---

### 问题 3: 第一次保存能看到，后续保存看不到
**可能原因**:
- `refreshLibrary` 的值没有变化（时间戳相同）

**检查方法**:
1. 查看日志中每次的 `refreshLibrary` 值
2. 确保每次都是不同的时间戳

**解决方法**:
- 使用 `Date.now()` 确保每次都是新值

---

## 成功标准

所有测试通过，满足以下条件：
- ✅ 每次保存后**立即**在配色库中看到新方案
- ✅ 无需手动刷新或切换 Tab
- ✅ 方案顺序正确（最新的在最上面）
- ✅ 删除后列表立即更新
- ✅ 日志中能看到完整的刷新流程

---

## 日志关键字

搜索以下关键字来追踪刷新流程：
- `开始保存配色方案`
- `保存结果 rowId`
- `触发刷新信号`
- `refreshLibrary 已更新为`
- `onRefreshLibrary 被触发`
- `开始加载配色方案`
- `从数据库获取到`
- `配色方案列表已更新`

---

## 预期时间线

完整的保存和刷新流程应该在 **1-2 秒**内完成：
1. 点击"保存" → 0ms
2. 数据库保存 → 100-300ms
3. 触发刷新信号 → 即时
4. 切换 Tab → 即时
5. `@Watch` 触发 → 即时
6. 重新加载数据 → 100-300ms
7. UI 更新 → 即时

**总计**: 约 200-600ms，用户感觉是**即时**的。

