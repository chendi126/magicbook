// é¦–é€‰é¡¹ç®¡ç†å™¨ - ç”¨äºå­˜å‚¨åº”ç”¨è®¾ç½®
import preferences from '@ohos.data.preferences';
import { Context } from '@ohos.abilityAccessCtrl';

export class PreferencesManager {
  private static instance: PreferencesManager;
  private preferences: preferences.Preferences | null = null;
  private readonly STORE_NAME = 'ColorAppPreferences';

  private constructor() {}

  static getInstance(): PreferencesManager {
    if (!PreferencesManager.instance) {
      PreferencesManager.instance = new PreferencesManager();
    }
    return PreferencesManager.instance;
  }

  // åˆå§‹åŒ–
  async init(context: Context): Promise<void> {
    try {
      this.preferences = await preferences.getPreferences(context, this.STORE_NAME);
      console.info('PreferencesManager åˆå§‹åŒ–æˆåŠŸ');
    } catch (err) {
      console.error('PreferencesManager åˆå§‹åŒ–å¤±è´¥: ' + JSON.stringify(err));
    }
  }

  // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä½¿ç”¨
  async isFirstLaunch(): Promise<boolean> {
    if (!this.preferences) {
      return true;
    }
    try {
      const isFirst = await this.preferences.get('isFirstLaunch', true);
      return isFirst as boolean;
    } catch (err) {
      console.error('è·å–é¦–æ¬¡å¯åŠ¨çŠ¶æ€å¤±è´¥: ' + JSON.stringify(err));
      return true;
    }
  }

  // è®¾ç½®å·²å®Œæˆé¦–æ¬¡å¼•å¯¼
  async setFirstLaunchCompleted(): Promise<void> {
    if (!this.preferences) {
      return;
    }
    try {
      await this.preferences.put('isFirstLaunch', false);
      await this.preferences.flush();
      console.info('é¦–æ¬¡å¯åŠ¨æ ‡è®°å·²è®¾ç½®');
    } catch (err) {
      console.error('è®¾ç½®é¦–æ¬¡å¯åŠ¨æ ‡è®°å¤±è´¥: ' + JSON.stringify(err));
    }
  }

  // è·å–å¼•å¯¼æ­¥éª¤
  async getGuideStep(): Promise<number> {
    if (!this.preferences) {
      return 0;
    }
    try {
      const step = await this.preferences.get('guideStep', 0);
      return step as number;
    } catch (err) {
      console.error('è·å–å¼•å¯¼æ­¥éª¤å¤±è´¥: ' + JSON.stringify(err));
      return 0;
    }
  }

  // è®¾ç½®å¼•å¯¼æ­¥éª¤
  async setGuideStep(step: number): Promise<void> {
    if (!this.preferences) {
      return;
    }
    try {
      await this.preferences.put('guideStep', step);
      await this.preferences.flush();
    } catch (err) {
      console.error('è®¾ç½®å¼•å¯¼æ­¥éª¤å¤±è´¥: ' + JSON.stringify(err));
    }
  }

  // è·å–è®¾ç½®é¡¹
  async getSetting(key: string, defaultValue: preferences.ValueType): Promise<preferences.ValueType> {
    if (!this.preferences) {
      return defaultValue;
    }
    try {
      return await this.preferences.get(key, defaultValue);
    } catch (err) {
      console.error(`è·å–è®¾ç½® ${key} å¤±è´¥: ` + JSON.stringify(err));
      return defaultValue;
    }
  }

  // ä¿å­˜è®¾ç½®é¡¹
  async setSetting(key: string, value: preferences.ValueType): Promise<void> {
    if (!this.preferences) {
      return;
    }
    try {
      await this.preferences.put(key, value);
      await this.preferences.flush();
    } catch (err) {
      console.error(`ä¿å­˜è®¾ç½® ${key} å¤±è´¥: ` + JSON.stringify(err));
    }
  }

  // è·å–ç”¨æˆ·å¤´åƒ
  async getUserAvatar(): Promise<string> {
    return await this.getSetting('userAvatar', 'ğŸ˜€') as string;
  }

  // è®¾ç½®ç”¨æˆ·å¤´åƒ
  async setUserAvatar(avatar: string): Promise<void> {
    await this.setSetting('userAvatar', avatar);
  }

  // è·å–ç”¨æˆ·åç§°
  async getUserName(): Promise<string> {
    return await this.getSetting('userName', 'è‰²å½©æ”¶é›†è€…') as string;
  }

  // è®¾ç½®ç”¨æˆ·åç§°
  async setUserName(name: string): Promise<void> {
    await this.setSetting('userName', name);
  }

  // æ¸…é™¤æ‰€æœ‰è®¾ç½®
  async clear(): Promise<void> {
    if (!this.preferences) {
      return;
    }
    try {
      await this.preferences.clear();
      await this.preferences.flush();
      console.info('æ‰€æœ‰è®¾ç½®å·²æ¸…é™¤');
    } catch (err) {
      console.error('æ¸…é™¤è®¾ç½®å¤±è´¥: ' + JSON.stringify(err));
    }
  }
}

