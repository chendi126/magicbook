// é¦–æ¬¡ä½¿ç”¨å¼•å¯¼é®ç½©å±‚
import { PreferencesManager } from '../utils/PreferencesManager';

// ç›®æ ‡ä½ç½®æ¥å£
export interface TargetPosition {
  x: number;
  y: number;
  width: number;
  height: number;
}

// å¼•å¯¼æ­¥éª¤æ¥å£
export interface GuideStep {
  title: string;
  description: string;
  targetPosition?: TargetPosition;
}

@Component
export struct GuideOverlay {
  @State currentStep: number = 0;
  @State showGuide: boolean = false;
  onComplete?: () => void;

  // å¼•å¯¼æ­¥éª¤
  private guideSteps: GuideStep[] = [
    {
      title: 'æ¬¢è¿ä½¿ç”¨è‰²å½©çµæ„Ÿæ”¶é›†å™¨ï¼',
      description: 'è®©æˆ‘ä»¬å¿«é€Ÿäº†è§£å¦‚ä½•ä½¿ç”¨è¿™ä¸ªåº”ç”¨'
    },
    {
      title: 'ğŸ“¸ æå–é…è‰²',
      description: 'ç‚¹å‡»"é€‰æ‹©å›¾ç‰‡"æŒ‰é’®ï¼Œä»ç…§ç‰‡ä¸­æå–ç¾ä¸½çš„é…è‰²æ–¹æ¡ˆ'
    },
    {
      title: 'ğŸ“š é…è‰²åº“',
      description: 'æ‰€æœ‰ä¿å­˜çš„é…è‰²æ–¹æ¡ˆéƒ½åœ¨è¿™é‡Œï¼Œæ”¯æŒæœç´¢ã€ç­›é€‰å’Œåˆ†ç»„'
    },
    {
      title: 'ğŸ¨ çµæ„Ÿå¹¿åœº',
      description: 'æµè§ˆ 30+ ç²¾é€‰é…è‰²æ–¹æ¡ˆï¼Œä¸€é”®ä¿å­˜åˆ°é…è‰²åº“'
    },
    {
      title: 'å¼€å§‹ä½¿ç”¨å§ï¼',
      description: 'ç°åœ¨ä½ å·²ç»äº†è§£äº†æ‰€æœ‰åŠŸèƒ½ï¼Œå¼€å§‹åˆ›ä½œå§ï¼'
    }
  ];

  aboutToAppear() {
    this.checkFirstLaunch();
  }

  // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡å¯åŠ¨
  async checkFirstLaunch() {
    const isFirst = await PreferencesManager.getInstance().isFirstLaunch();
    if (isFirst) {
      this.showGuide = true;
    }
  }

  // ä¸‹ä¸€æ­¥
  nextStep() {
    if (this.currentStep < this.guideSteps.length - 1) {
      this.currentStep++;
    } else {
      this.completeGuide();
    }
  }

  // è·³è¿‡å¼•å¯¼
  skipGuide() {
    this.completeGuide();
  }

  // å®Œæˆå¼•å¯¼
  async completeGuide() {
    this.showGuide = false;
    await PreferencesManager.getInstance().setFirstLaunchCompleted();
    if (this.onComplete) {
      this.onComplete();
    }
  }

  build() {
    if (this.showGuide) {
      Stack() {
        // åŠé€æ˜é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.7)')

        // å¼•å¯¼å†…å®¹
        Column() {
          // æ­¥éª¤æŒ‡ç¤ºå™¨
          Row() {
            ForEach(this.guideSteps, (step: GuideStep, index: number) => {
              Column()
                .width(this.currentStep === index ? 24 : 8)
                .height(8)
                .backgroundColor(this.currentStep === index ? '#007DFF' : '#CCCCCC')
                .borderRadius(4)
                .margin({ right: 8 })
                .animation({
                  duration: 300,
                  curve: Curve.EaseInOut
                })
            }, (step: GuideStep, index: number) => index.toString())
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 32 })

          // æ ‡é¢˜
          Text(this.guideSteps[this.currentStep].title)
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 16 })

          // æè¿°
          Text(this.guideSteps[this.currentStep].description)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Center)
            .lineHeight(24)
            .margin({ bottom: 48 })

          // æŒ‰é’®
          Row() {
            if (this.currentStep > 0) {
              Button('è·³è¿‡')
                .fontSize(16)
                .fontColor('#FFFFFF')
                .backgroundColor('rgba(255, 255, 255, 0.2)')
                .width(100)
                .onClick(() => {
                  this.skipGuide();
                })
            }

            Button(this.currentStep === this.guideSteps.length - 1 ? 'å¼€å§‹ä½¿ç”¨' : 'ä¸‹ä¸€æ­¥')
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#007DFF')
              .width(120)
              .margin({ left: this.currentStep > 0 ? 16 : 0 })
              .onClick(() => {
                this.nextStep();
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .width('80%')
        .padding(32)
        .backgroundColor('rgba(0, 0, 0, 0.9)')
        .borderRadius(16)
      }
      .width('100%')
      .height('100%')
    }
  }
}

